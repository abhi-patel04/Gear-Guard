{% extends 'base.html' %}
{% load static %}
{% load maintenance_tags %}

{% block title %}Kanban Board - GearGuard{% endblock %}

{% block page_header %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <i class="bi bi-kanban"></i>
                Kanban Board
            </h1>
            <p class="page-subtitle">Visual workflow management - Drag cards to change status</p>
        </div>
        <div>
            <a href="{% url 'maintenance:create' %}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i>
                New Request
            </a>
            <a href="{% url 'maintenance:list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-list-ul"></i>
                List View
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
{# CSRF Token for AJAX requests #}
{% csrf_token %}
<div style="display: none;"></div>

{# Kanban Board #}
<div class="kanban-board" id="kanbanBoard">
    <div class="row g-3">
        {% for status in statuses %}
            <div class="col-md-3">
                <div class="card kanban-column" data-status="{{ status }}">
                    <div class="card-header kanban-column-header">
                        <h5 class="mb-0 d-flex justify-content-between align-items-center">
                            <span>
                                {% if status == 'New' %}
                                    <i class="bi bi-circle"></i>
                                {% elif status == 'In Progress' %}
                                    <i class="bi bi-arrow-repeat"></i>
                                {% elif status == 'Repaired' %}
                                    <i class="bi bi-check-circle"></i>
                                {% elif status == 'Scrap' %}
                                    <i class="bi bi-x-circle"></i>
                                {% endif %}
                                {{ status }}
                            </span>
                            <span class="badge bg-secondary">
                                {{ requests_by_status|get_item:status|length }}
                            </span>
                        </h5>
                    </div>
                    <div class="card-body kanban-column-body" 
                         id="column-{{ status|lower|slugify }}"
                         data-status="{{ status }}">
                        {% for req in requests_by_status|get_item:status %}
                            {% include 'maintenance/kanban_card.html' with maintenance_request=req %}
                        {% empty %}
                            <div class="kanban-empty">
                                <i class="bi bi-inbox"></i>
                                <p class="text-muted mb-0">No requests</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .kanban-board {
        min-height: 600px;
    }
    
    .kanban-column {
        min-height: 500px;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    
    .kanban-column-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .kanban-column-body {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        min-height: 400px;
    }
    
    .kanban-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: move;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .kanban-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    .kanban-card.dragging {
        opacity: 0.5;
    }
    
    .kanban-card.overdue {
        border-left: 4px solid #dc3545;
    }
    
    .kanban-empty {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }
    
    .kanban-empty i {
        font-size: 3rem;
        opacity: 0.3;
    }
    
    /* SortableJS placeholder */
    .sortable-ghost {
        opacity: 0.4;
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
    }
    
    /* Column colors */
    .kanban-column[data-status="New"] .kanban-column-header {
        background-color: #e7f3ff;
        border-bottom-color: #0dcaf0;
    }
    
    .kanban-column[data-status="In Progress"] .kanban-column-header {
        background-color: #fff3cd;
        border-bottom-color: #ffc107;
    }
    
    .kanban-column[data-status="Repaired"] .kanban-column-header {
        background-color: #d1e7dd;
        border-bottom-color: #198754;
    }
    
    .kanban-column[data-status="Scrap"] .kanban-column-header {
        background-color: #f8d7da;
        border-bottom-color: #dc3545;
    }
</style>
{% endblock %}

{% block extra_js %}
{# SortableJS #}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize SortableJS for each column
    const columns = document.querySelectorAll('.kanban-column-body');
    const statuses = ['New', 'In Progress', 'Repaired', 'Scrap'];
    
    columns.forEach(function(column) {
        const status = column.getAttribute('data-status');
        
        new Sortable(column, {
            group: 'kanban',
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'dragging',
            onEnd: function(evt) {
                // Get the card that was moved
                const card = evt.item;
                const requestId = card.getAttribute('data-request-id');
                const newStatus = evt.to.getAttribute('data-status');
                const oldStatus = evt.from.getAttribute('data-status');
                
                // Don't do anything if dropped in same column
                if (newStatus === oldStatus) {
                    return;
                }
                
                // Get CSRF token
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                 document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
                
                // Update status via fetch
                fetch(`/maintenance/${requestId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrftoken
                    },
                    body: `status=${encodeURIComponent(newStatus)}`
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to update status');
                    }
                    return response.text();
                })
                .then(html => {
                    // Replace card with updated HTML
                    card.outerHTML = html;
                    
                    // Show success message
                    // Show success message
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    toast.style.zIndex = '9999';
                    toast.innerHTML = `
                        <strong>Success!</strong> Request status updated to ${newStatus}.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(toast);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(function() {
                        toast.remove();
                    }, 3000);
                })
                .catch(function(error) {
                    // Revert on error
                    evt.from.appendChild(card);
                    
                    // Show error message
                    const toast = document.createElement('div');
                    toast.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 end-0 m-3';
                    toast.style.zIndex = '9999';
                    toast.innerHTML = `
                        <strong>Error!</strong> Could not update status. Please try again.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(toast);
                    
                    setTimeout(function() {
                        toast.remove();
                    }, 5000);
                });
            }
        });
    });
});
</script>
{% endblock %}
